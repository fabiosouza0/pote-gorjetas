<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pote de Gorjetas — Compartilhado</title>
<style>
/* (mesmo estilo do protótipo anterior, simplificado) */
:root{--bg:#0f1724;--muted:#9aa6b2}
*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui;display:flex;align-items:center;justify-content:center;height:100vh;background:#071427;color:#e6eef6;padding:16px}
.card{width:min(720px,100%);background:rgba(255,255,255,0.02);padding:18px;border-radius:14px;display:grid;grid-template-columns:1fr 180px;gap:12px}
@media(max-width:720px){.card{grid-template-columns:1fr}.controls{flex-direction:row}}
.jar{background:linear-gradient(180deg,#01283a,#013a50);border-radius:12px;padding:16px;position:relative;overflow:hidden;min-height:120px}
.total{font-size:36px;font-weight:700;display:flex;align-items:center;gap:8px}
.controls{display:flex;flex-direction:column;gap:10px;align-items:stretch}
button{border:0;padding:12px;border-radius:10px;font-weight:700;cursor:pointer}
.btn-add{background:linear-gradient(90deg,#ffb84d,#ffd166);color:#071322}
.btn-reset{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
.coin{position:absolute;width:36px;height:36px;animation:floatUp 1.1s forwards;pointer-events:none}
@keyframes floatUp{0%{transform:translateY(0) opacity:1}100%{transform:translateY(-150px) scale(.8) rotate(50deg) opacity:0}}
.muted{color:var(--muted);font-size:13px}
</style>
</head>
<body>
  <div class="card" role="application">
    <div>
      <h1>Pote de Gorjetas (Compartilhado)</h1>
      <p class="muted">Clique +5 e todos conectados verão o total sendo atualizado em tempo real.</p>
      <div class="jar" id="jar" aria-live="polite">
        <div class="total"><span id="amount">0</span> <span class="muted">¢</span></div>
        <div id="subtitle" class="muted">Total</div>
      </div>
    </div>
    <div class="controls">
      <button id="add5" class="btn-add">+5</button>
      <button id="reset" class="btn-reset">Redefinir</button>
      <div id="status" class="muted" style="font-size:12px;text-align:center;margin-top:6px">Conectando...</div>
    </div>
  </div>

  <!-- Firebase CDN (versão compatível v8 — simples de integrar) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDe_CON0OGCFSQTRdSdIl_80Lz9f3hIUTM",
  authDomain: "pote-gorjetas.firebaseapp.com",
  databaseURL: "https://pote-gorjetas-default-rtdb.firebaseio.com",
  projectId: "pote-gorjetas",
  storageBucket: "pote-gorjetas.firebasestorage.app",
  messagingSenderId: "184073135173",
  appId: "1:184073135173:web:b91c4f0cf268a4ee2b2f2c"
};

// Inicializa Firebase
if(!firebaseConfig || !firebaseConfig.apiKey){
  document.getElementById('status').textContent = 'Cole o firebaseConfig no arquivo e recarregue a página.';
  throw new Error('Coloque o firebaseConfig');
}
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const STEP = 5;
const amountEl = document.getElementById('amount');
const addBtn = document.getElementById('add5');
const resetBtn = document.getElementById('reset');
const jar = document.getElementById('jar');
const statusEl = document.getElementById('status');

let localTotal = 0;
let updating = false;

// Listener: atualiza quando o valor no DB muda
const totalRef = db.ref('tipjar/total');
totalRef.on('value', snap => {
  const val = snap.val();
  if(val == null) {
    // inicializa no DB se não existir
    totalRef.set(0).catch(console.error);
    return;
  }
  const newTotal = parseInt(val, 10) || 0;
  // Se a diferença for positiva e não veio do próprio clique local (ou veio), animar moedas
  const delta = newTotal - localTotal;
  if(delta > 0) spawnCoins(delta);
  localTotal = newTotal;
  amountEl.textContent = localTotal;
  statusEl.textContent = 'Conectado';
});

// Função para incrementar usando transaction (evita corridas)
function addAmount(n){
  if(updating) return; // evita spam local — transações já protegem, isso é UX
  updating = true;
  totalRef.transaction(current => {
    return (current || 0) + n;
  }, (err, committed, snapshot) => {
    updating = false;
    if(err) {
      console.error('Transação falhou', err);
      statusEl.textContent = 'Erro ao atualizar';
    } else if(!committed) {
      statusEl.textContent = 'Não confirmado';
    } else {
      // spawnCoins será chamado pela listener assim que o value for propagado
      // mas podemos tocar feedback imediato:
      // spawnCoins(n);
      statusEl.textContent = 'Atualizado';
      setTimeout(()=> statusEl.textContent = 'Conectado', 800);
    }
  });
}

// Resetar (substitui valor) — só use se realmente quiser permitir reset público
resetBtn.addEventListener('click', () => {
  if(!confirm('Redefinir total para 0?')) return;
  totalRef.set(0).catch(err => {
    console.error(err);
    statusEl.textContent = 'Erro ao resetar';
  });
});

// Clique +5
addBtn.addEventListener('click', ()=> addAmount(STEP));

// animação de moedas (igual ao protótipo)
function spawnCoins(n){
  const coins = Math.min(8, Math.ceil(n / STEP));
  for(let i=0;i<coins;i++){
    const c = document.createElement('div');
    c.className = 'coin';
    c.innerHTML = `<svg viewBox="0 0 24 24" width="36" height="36" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#ffd166"/><path d="M12 8v8M9 11h6" stroke="#0b1220" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    const jarRect = jar.getBoundingClientRect();
    const left = Math.random() * (jarRect.width - 40) + 8;
    c.style.left = left + 'px';
    c.style.bottom = (8 + Math.random() * 18) + 'px';
    c.style.animationDuration = (0.9 + Math.random() * 0.6) + 's';
    jar.appendChild(c);
    c.addEventListener('animationend', ()=> c.remove());
  }
}

// fallback: se desconectar do DB
db.ref('.info/connected').on('value', snap => {
  const con = snap.val();
  statusEl.textContent = con ? 'Conectado' : 'Offline';
});
</script>
</body>
</html>
